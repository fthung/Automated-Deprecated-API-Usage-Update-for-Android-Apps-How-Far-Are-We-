On our dataset, AppEvolve produces 10 applicable updates and 44 failed
updates. The original AppEvolve evaluation also showed 4 failed updates.
After investigating the 48 failed updates, we found some common reasons for
the failures, as described below. Table~\ref{table:data_statistic} shows
the number of occurrences of each of these issues.

% \begin{table}
% \caption{Update findings statistic}
% \begin{center}
% \begin{tabular}{ | p{8em} |c|c| } 
%  \hline
%  \textbf{Test Case Type} & \textbf{Detail of Cases} & \textbf{Number of Cases} \\ 
%  \hline
%  Work in AppEvolve & - & 10 \\ 
%  \hline
%  \multirow{7}{8em}{Fixed with simple refactor} & Total cases & 36 \\\cline{2-3} & Return statement & 6 \\\cline{2-3} & If statement & 1 \\\cline{2-3} & Method argument & 4 \\\cline{2-3} & Arithmetic operand & 3 \\\cline{2-3}  & Variable declaration & 12 \\\cline{2-3} & Complex expression & 20 \\\cline{2-3} 
%  \hline
%  \multirow{3}{8em}{Incomplete support of programming language features} & Inheritance & 2\\\cline{2-3} & Static modifier & 1 \\\cline{2-3} & Final modifier & 1\\\cline{2-3}
%  \hline
%  Unknown error & - & 4\\
%  \hline
% \end{tabular}
% \end{center}
% \label{table:data_statistic}
% \end{table}

\begin{table}
\caption{Update findings statistics}
\begin{center}
\begin{tabular}{ | p{12em} |c|c| } 
 \hline
 \textbf{Test Case Type} & \textbf{Subcategory} & \textbf{Occurrences} \\ 
 %\hline
 %Work in AppEvolve & - & 10 \\ 
 \hline
 \multirow{5}{12em}{Statements in the examples and at the target location are structurally different} & Return statement & 6 \\\cline{2-3} & If statement & 1 \\\cline{2-3} & Method argument & 4 \\\cline{2-3} & Arithmetic operand & 3 \\\cline{2-3}  & Declared variable & 12 \\\cline{2-3} 
 \hline
  \multirow{4}{12em}{Object and arguments of the deprecated API method are in the form of complex expressions} & - & 20\\&&\\&&\\&&\\
 \hline
 Edits beyond method boundaries & - & 3\\
\hline
 \multirow{3}{12em}{Incomplete support of programming-language features} & Inheritance & 2\\\cline{2-3} & Static modifier & 1 \\\cline{2-3} & Final modifier & 1\\\cline{2-3}
 \hline
 No examples & - & 1\\
 \hline
 Others & - & 4\\
 \hline
 \multicolumn{2}{|l|}{\bf Total} & 48\\
 \hline
\end{tabular}
\end{center}
\label{table:data_statistic}
\end{table}

\begin{enumerate}
\item {\em The statements in the examples and at the target location are
 structurally different.} AppEvolve infers edit operations at the statement
 level (insert of a statement, move of a statement, etc).  Accordingly,
 AppEvolve is not able to apply changes inferred about a method call found
 in one kind of statement to a method use found in another kind of
 statement.  In the training set used in the evaluation of AppEvolve, it
 often occurs that the invocation of the deprecated API method invocation
 is used as the right hand side of an assignment, while in our dataset the
 API method invocations occur in a variety of expression contexts.  We now
 present some examples:
\begin{itemize}
\item Return statement: 
In the code shown on the left side of Listing 1 in
Table~\ref{tab:mitigatesucc}, an invocation of the deprecated method {\tt
fromHtml} appears as part of a return statement of the {\tt getTitle}
method.

\item If statement test:
In the code shown on the left side of Listing 2 in
Table~\ref{tab:mitigatesucc}, an invocation of the deprecated method {\tt
requestAudioFocus} appears as a subexpression of the test expression of a
conditional.

\item Method argument:
In the code shown on the left side of Listing 3 in
Table~\ref{tab:mitigatesucc}, an invocation of the deprecated method {\tt
getCurrentHour} appears as the second argument of the method {\tt
String.format}.

\item Arithmetic operand:
In the code shown on the left side of Listing 4 in
Table~\ref{tab:mitigatesucc}, an invocation of the deprecated method {\tt
getCurrentHour} appears as the left argument of a concatenation with the
string {\tt ":"}.

\item Declared variable:
In the code shown on the left side of Listing 5 in
Table~\ref{tab:mitigatesucc}, an invocation of the deprecated method {\tt
getCurrentHour} appears as the initial value of a declared variable.  Even
though it involves an assignment, such code does not match examples where
the assignment involves a previously declared variable.
\end{itemize}

\item {\em Object and arguments of the deprecated API method are in the form of complex expressions.} The invocation of a deprecated method in the example that AppEvolve may learn from may use variables for the object and arguments of the method. These edits do not work when the object and arguments use complex expresssions. AppEvolve is not flexible enough to apply the edits correctly by treating these expressions as variables. The code in the left hand side of Listing 6 in Table~\ref{tab:mitigatesucc} shows an example of this case. The deprecated API method in this listing is {\tt setTextAppearance}.

\item {\em Edits beyond method boundaries.} AppEvolve cannot learn edits that modify program elements that reside outside the boundaries of the method containing the API usage to be updated. These edits include operations such as adding imports and adding fields to a class. Below is a snippet of an update example that involves edits beyond method boundaries.
\begin{lstlisting}[language=diff,numbers=none,caption=Edits that add imports and a private field,captionpos=b]
18a19
+ import android.location.GnssStatus;
22a24
+ import android.os.Build;
33a36,37
+ private GnssStatus.Callback callback;
41c45,51
- locationManager.addGpsStatusListener(listener);
+ if (android.os.Build.VERSION.SDK_INT >= 
            android.os.Build.VERSION_CODES.N) {
+   locationManager.registerGnssStatusCallback(callback);
+ }
+ else{
+   locationManager.addGpsStatusListener(listener);
+ }
\end{lstlisting}
The deprecated API in the above example is {\tt addGpsStatusListener}. Updating this API requires adding a private field named {\tt callback} of type {\em GnssStatus.Callback}. Unfortunately, since AppEvolve only learn edits inside a method containing the deprecated API usage, it misses this necessary addition.

\item {\em Incomplete support of programming language features.} AppEvolve fails to update cases in which the update involve programming language features such as:
\begin{itemize}
\item Inheritance: The code in the left hand side of Listing 7 in Table~\ref{tab:mitigatefail} shows an example of this case.  The deprecated API method is {\tt setAudioStreamType} of the class {\tt Media Player.} In the above snippet, {\tt TestMediaPlayer} extends {\tt MediaPlayer} and thus it inherits the {\tt setAudioStreamType} method. This method should be updated but AppEvolve does not seem to recognize it due to the use of inheritance.
\item Static modifier:  The code in the left hand side of Listing 8 in Table~\ref{tab:mitigatefail} shows an example of this case.  The deprecated API method {\tt requestAudioFocus} is invoked by {\tt mAudioManager}, which is a static field.

\item Final modifier: The code in the left hand side of Listing 9 in Table~\ref{tab:mitigatefail} shows an example of this case.  Variable {\tt paint} that is used as the deprecated API method {\tt saveLayer} fourth argument is a final field.

\end{itemize}

\item {\em No examples.} There is no example for such API update that can be found in GitHub. 

\item {\em Others.} These include cases that cannot be put to any category above.
\end{enumerate}


\newcolumntype{Y}{>{\centering\arraybackslash}X}

\lstset{
	language=text,numbers=none,
	breaklines=true,
	aboveskip=-7pt,
	belowskip= -6pt
}

\begin{table*}
\centering
\caption{Successful simple refactoring mitigations that allows AppEvolve to generate applicable updates}\label{tab:mitigatesucc}
\begin{tabular}{|p{.10\textwidth}|p{.40\textwidth}|p{.40\textwidth}|}
\hline
\textbf{Listing}
  &
  \textbf{Original Code}
  &
  \textbf{Refactored Code}
 \\ \hline
1. Structurally different: return statement
&
\begin{lstlisting}
Spanned getTitle(){
    return Html.fromHtml(title);
}
\end{lstlisting}
&
\begin{lstlisting}[language=diff]
Spanned getTitle(){
+   Spanned a;
+   a = Html.fromHtml(title);
-   return Html.fromHtml(title);
+   return a;
}
\end{lstlisting}
\\ \hline
2. Structurally different: if statement
&
\begin{lstlisting}
public void play() {
    if (mAudioManager.requestAudioFocus(
    mAudioFocusListener, AudioManager.STREAM_MUSIC,
    AudioManager.AUDIOFOCUS_GAIN) != 
    AudioManager.AUDIOFOCUS_REQUEST_GRANTED) {
        return;
    }
}
\end{lstlisting}
&
\begin{lstlisting}[language=diff]
public void play() {
-   if (mAudioManager.requestAudioFocus
-     (mAudioFocusListener, AudioManager.
-           STREAM_MUSIC,
-     AudioManager.AUDIOFOCUS_GAIN) !=
-     AudioManager.AUDIOFOCUS_REQUEST_GRANTED) {
-     return;
-   }
+   int res;
+   int arg1=AudioManager.STREAM_MUSIC;
+   int arg2=AudioManager.AUDIOFOCUS_GAIN;
+   res = mAudioManager.requestAudioFocus (mAudioFocusListener, arg1, arg2);
+   if (res != AudioManager
+     .AUDIOFOCUS_REQUEST_GRANTED) {
+     return;
+   }
}
\end{lstlisting}
\\ \hline
3. Structurally different: method argument
&
\begin{lstlisting}
protected String getInputDataString() {
    return String.format("\%02d:\%02d", 
    timePicker.getCurrentHour(), 
    timePicker.getCurrentMinute());
}
\end{lstlisting}
&
\begin{lstlisting}[language=diff]
protected String getInputDataString() {
+   int hour;
+   hour = timePicker.getCurrentHour();
+   return String.format("%02d:%02d", hour,
+   timePicker.getCurrentMInute());
-   return String.format("\%02d:\%02d", 
-   timePicker.getCurrentHour(), 
-   timePicker.getCurrentMinute());
}
\end{lstlisting}
\\ \hline
4. Structurally different: arithmetic operand
&
\begin{lstlisting}
public void displayTime(View view) {
    String time = timePicker.getCurrentHour() 
	    + ":" + timePicker.getCurrentMinute();
    Toast.makeText(this, time, 
        Toast.LENGTH_SHORT).show();
}
\end{lstlisting}
&
\begin{lstlisting}[language=diff]
public void displayTime(View view) {
+   int hour;
+   hour = timePicker.getCurrentHour();
+   String time = hour + ":" +
+     timePicker.getCurrentMinute();
-   String time = timePicker.getCurrentHour()
-      + ":" + timePicker.getCurrentMinute();
    Toast.makeText(this, time, 
        Toast.LENGTH_SHORT).show();
}
\end{lstlisting}
\\ \hline
5. Direct assignment after declaration
&
\begin{lstlisting}
public Schedule generate() {
    TimePicker timePicker = (TimePicker) activity
        .findViewById(R.id.timePicker);
    int hours = timePicker.getCurrentHour();
    int minutes = timePicker.getCurrentMinute();
    SeekBar seekBar = (SeekBar) activity
        .findViewById(R.id.setLuminosity);
    int luminosity = seekBar.getProgress();
    return new Schedule(hours, minutes, luminosity);
}
\end{lstlisting}
&
\begin{lstlisting}[language=diff]
public Schedule generate() {
    TimePicker timePicker = (TimePicker) activity
        .findViewById(R.id.timePicker);
+   int hours;
+   hours = timePicker.getCurrentHour();
-   int hours = timePicker.getCurrentHour();
    int minutes = timePicker.getCurrentMinute();
    SeekBar seekBar = (SeekBar) activity
        .findViewById(R.id.setLuminosity);
    int luminosity = seekBar.getProgress();
    return new Schedule(hours, minutes, luminosity);
}
\end{lstlisting}
\\ \hline
6. Complex expressions
&
\begin{lstlisting}
protected void onClick() {
    ...
    Dialog d = builder.create();
    d.show();
    ((TextView) d.findViewById(android.R.id.message))
        .setTextAppearance(getContext(), 
        android.R.style.TextAppearance_Small);
    ...
}
\end{lstlisting}
&
\begin{lstlisting}[language=diff]
protected void onClick() {  
    ...
    Dialog d = builder.create();
    d.show();
-   ((TextView) d.findViewById(android.R.id.
-     message))
-   .setTextAppearance(getContext(), 
-    android.R.style.TextAppearance_Small);
+   Context c = getContext();
+   int i = android.R.style.
+         TextAppearance_Small;
+   TextView t = ((TextView) d.findViewById
+     (android.R.id.message)); 
+   t.setTextAppearance(c, i);
    ...
}
\end{lstlisting}
\\ \hline


\end{tabular} 
\end{table*}

\begin{table}
	\caption{Failed categories that are unhandled by our mitigations}\label{tab:mitigatefail}
\centering
\begin{tabular}{|p{.08\textwidth}|p{.35\textwidth}|}
\hline
\textbf{Listing}
  &
  \textbf{Original Code}
 \\ \hline
7. Incomplete support: inheritance
&
\begin{lstlisting}
public class TestMediaPlayer extends MediaPlayer {
    public TestMediaPlayer() {
        setAudioStreamType(AudioManager.STREAM_MUSIC);
    }
    public TestMediaPlayer(Context testContext, 
        int withResource) throws Exception {
        this();
        AssetFileDescriptor afd = 
            testContext.getResources()
            .openRawResourceFd(withResource);
        assertNotNull(afd);
        setDataSource(afd.getFileDescriptor()
            , afd.getStartOffset(), afd.getLength());
        afd.close();
        prepare();
    }
}
\end{lstlisting}
\\ \hline
8. Incomplete support: static
&
\begin{lstlisting}
private static AudioManager mAudioManager;
private static OnAudioFocusChangeListener afChangeListener;
public static void requestAudioFocus
    (Context context) {
    if(mAudioManager == null){
        mAudioManager = (AudioManager) 
            context.getApplicationContext()
            .getSystemService
            (Context.AUDIO_SERVICE);
    }
    mAudioManager.requestAudioFocus(
        afChangeListener,
        AudioManager.STREAM_MUSIC,
        AudioManager.AUDIOFOCUS_GAIN);
}
\end{lstlisting}
\\ \hline
9. Incomplete support: final
&
\begin{lstlisting}
private final Paint paint;
@Override protected void onDraw(Canvas canvas) {
    super.onDraw(canvas);
    canvas.drawColor(Color.GREEN);
    canvas.saveLayer(0, 0, canvas.getWidth(),
        canvas.getHeight(), paint, 
        Canvas.ALL_SAVE_FLAG);
    canvas.restore();
}
\end{lstlisting}
\\ \hline
 \end{tabular}
 \end{table}

  \lstdefinelanguage{text}{
	basicstyle=\ttfamily\extrabold\scriptsize,
	identifierstyle=\color{black},
	aboveskip=5pt,
	belowskip= 5pt
}
